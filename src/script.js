const data = {
  isCapsed: false,
  englishLang: true,
  display: [],
  ru: [
    {
      code: 'Backquote',
      key: 'ё',
      shiftKey: '~',
    },
    {
      code: 'Digit1',
      key: '1',
      shiftKey: '!',
    },
    {
      code: 'Digit2',
      key: '2',
      shiftKey: '"',
    },
    {
      code: 'Digit3',
      key: '3',
      shiftKey: '№',
    },
    {
      code: 'Digit4',
      key: '4',
      shiftKey: ';',
    },
    {
      code: 'Digit5',
      key: '5',
      shiftKey: '%',
    },
    {
      code: 'Digit6',
      key: '6',
      shiftKey: ':',
    },
    {
      code: 'Digit7',
      key: '7',
      shiftKey: '?',
    },
    {
      code: 'Digit8',
      key: '8',
      shiftKey: '*',
    },
    {
      code: 'Digit9',
      key: '9',
      shiftKey: '(',
    },
    {
      code: 'Digit0',
      key: '0',
      shiftKey: ')',
    },
    {
      code: 'Minus',
      key: '-',
      shiftKey: '_',
    },
    {
      code: 'Equal',
      key: '=',
      shiftKey: '+',
    },
    {
      code: 'Backspace',
      key: 'Backspace',
    },
    {
      code: 'Tab',
      key: 'Tab',
    },
    {
      code: 'KeyQ',
      key: 'й',
      capsKey: 'Й',
      shiftKey: 'Й',
    },
    {
      code: 'KeyW',
      key: 'ц',
      capsKey: 'Ц',
      shiftKey: 'Ц',
    },
    {
      code: 'KeyE',
      key: 'у',
      capsKey: 'У',
      shiftKey: 'У',
    },
    {
      code: 'KeyR',
      key: 'к',
      capsKey: 'К',
      shiftKey: 'К',
    },
    {
      code: 'KeyT',
      key: 'е',
      capsKey: 'Е',
      shiftKey: 'Е',
    },
    {
      code: 'KeyY',
      key: 'н',
      capsKey: 'Н',
      shiftKey: 'Н',
    },
    {
      code: 'KeyU',
      key: 'г',
      capsKey: 'Г',
      shiftKey: 'Г',
    },
    {
      code: 'KeyI',
      key: 'ш',
      capsKey: 'Ш',
      shiftKey: 'Ш',
    },
    {
      code: 'KeyO',
      key: 'щ',
      capsKey: 'Щ',
      shiftKey: 'Щ',
    },
    {
      code: 'KeyP',
      key: 'з',
      capsKey: 'З',
      shiftKey: 'З',
    },
    {
      code: 'BracketLeft',
      key: 'х',
      shiftKey: 'Х',
      capsKey: 'Х',
    },
    {
      code: 'BracketRight',
      key: 'ъ',
      shiftKey: 'Ъ',
      capsKey: 'Ъ',
    },
    {
      code: 'Backslash',
      key: '&#92',
      shiftKey: '|',
    },
    {
      code: 'Delete',
      key: 'Del',
    },
    {
      code: 'CapsLock',
      key: 'CapsLock',
    },
    {
      code: 'KeyA',
      key: 'ф',
      capsKey: 'Ф',
      shiftKey: 'Ф',
    },
    {
      code: 'KeyS',
      key: 'ы',
      capsKey: 'Ы',
      shiftKey: 'Ы',
    },
    {
      code: 'KeyD',
      key: 'в',
      capsKey: 'В',
      shiftKey: 'В',
    },
    {
      code: 'KeyF',
      key: 'а',
      capsKey: 'А',
      shiftKey: 'А',
    },
    {
      code: 'KeyG',
      key: 'п',
      capsKey: 'П',
      shiftKey: 'П',
    },
    {
      code: 'KeyH',
      key: 'р',
      capsKey: 'Р',
      shiftKey: 'Р',
    },
    {
      code: 'KeyJ',
      key: 'о',
      capsKey: 'О',
      shiftKey: 'О',
    },
    {
      code: 'KeyK',
      key: 'л',
      capsKey: 'Л',
      shiftKey: 'Л',
    },
    {
      code: 'KeyL',
      key: 'д',
      capsKey: 'Д',
      shiftKey: 'Д',
    },
    {
      code: 'Semicolon',
      key: 'ж',
      shiftKey: 'Ж',
      capsKey: 'Ж',
    },
    {
      code: 'Quote',
      key: 'э',
      rightAlt: 'Э',
      capsKey: 'Э',
      shiftKey: 'Э',
    },
    {
      code: 'Enter',
      key: 'Enter',
    },
    {
      code: 'ShiftLeft',
      key: 'Shift',
    },
    {
      code: 'KeyZ',
      key: 'я',
      capsKey: 'Я',
      shiftKey: 'Я',
    },
    {
      code: 'KeyX',
      key: 'ч',
      capsKey: 'Ч',
      shiftKey: 'Ч',
    },
    {
      code: 'KeyC',
      key: 'с',
      capsKey: 'С',
      shiftKey: 'С',
    },
    {
      code: 'KeyV',
      key: 'м',
      capsKey: 'М',
      shiftKey: 'М',
    },
    {
      code: 'KeyB',
      key: 'и',
      capsKey: 'И',
      shiftKey: 'И',
    },
    {
      code: 'KeyN',
      key: 'т',
      capsKey: 'Т',
      shiftKey: 'Т',
    },
    {
      code: 'KeyM',
      key: 'ь',
      capsKey: 'Ь',
      shiftKey: 'Ь',
    },
    {
      code: 'Comma',
      key: 'б',
      shiftKey: 'Б',
      capsKey: 'Б',
    },
    {
      code: 'Period',
      key: 'ю',
      shiftKey: 'Ю',
      capsKey: 'Ю',
    },
    {
      code: 'Slash',
      key: '/',
      shiftKey: '?',
    },
    {
      code: 'ArrowUp',
      key: '&uarr;',
    },
    {
      code: 'ShiftRight',
      key: 'Shift',
    },
    {
      code: 'ControlLeft',
      key: 'Ctrl',
    },
    {
      code: 'MetaLeft',
      key: 'Win',
    },
    {
      code: 'AltLeft',
      key: 'Alt',
    },
    {
      code: 'Space',
      key: ' ',
    },
    {
      code: 'AltRight',
      key: 'Alt',
    },
    {
      code: 'ArrowLeft',
      key: '&larr;',
    },
    {
      code: 'ArrowDown',
      key: '&darr;',
    },
    {
      code: 'ArrowRight',
      key: '&rarr;',
    },
    {
      code: 'ControlRight',
      key: 'Ctrl',
    },
  ],
  eng: [
    {
      code: 'Backquote',
      key: '`',
      shiftKey: '~',
    },
    {
      code: 'Digit1',
      key: '1',
      shiftKey: '!',
    },
    {
      code: 'Digit2',
      key: '2',
      shiftKey: '@',
    },
    {
      code: 'Digit3',
      key: '3',
      shiftKey: '#',
    },
    {
      code: 'Digit4',
      key: '4',
      shiftKey: '$',
    },
    {
      code: 'Digit5',
      key: '5',
      shiftKey: '%',
    },
    {
      code: 'Digit6',
      key: '6',
      shiftKey: '^',
    },
    {
      code: 'Digit7',
      key: '7',
      shiftKey: '&',
    },
    {
      code: 'Digit8',
      key: '8',
      shiftKey: '*',
    },
    {
      code: 'Digit9',
      key: '9',
      shiftKey: '(',
    },
    {
      code: 'Digit0',
      key: '0',
      shiftKey: ')',
    },
    {
      code: 'Minus',
      key: '-',
      shiftKey: '_',
    },
    {
      code: 'Equal',
      key: '=',
      shiftKey: '+',
    },
    {
      code: 'Backspace',
      key: 'Backspace',
    },
    {
      code: 'Tab',
      key: 'Tab',
    },
    {
      code: 'KeyQ',
      key: 'q',
      capsKey: 'Q',
      shiftKey: 'Q',
    },
    {
      code: 'KeyW',
      key: 'w',
      capsKey: 'W',
      shiftKey: 'W',
    },
    {
      code: 'KeyE',
      key: 'e',
      capsKey: 'E',
      shiftKey: 'E',
    },
    {
      code: 'KeyR',
      key: 'r',
      capsKey: 'R',
      shiftKey: 'R',
    },
    {
      code: 'KeyT',
      key: 't',
      capsKey: 'T',
      shiftKey: 'T',
    },
    {
      code: 'KeyY',
      key: 'y',
      capsKey: 'Y',
      shiftKey: 'Y',
    },
    {
      code: 'KeyU',
      key: 'u',
      capsKey: 'U',
      shiftKey: 'U',
    },
    {
      code: 'KeyI',
      key: 'i',
      capsKey: 'I',
      shiftKey: 'I',
    },
    {
      code: 'KeyO',
      key: 'o',
      capsKey: 'O',
      shiftKey: 'O',
    },
    {
      code: 'KeyP',
      key: 'p',
      capsKey: 'P',
      shiftKey: 'P',
    },
    {
      code: 'BracketLeft',
      key: '[',
      shiftKey: '{',
    },
    {
      code: 'BracketRight',
      key: ']',
      shiftKey: '}',
    },
    {
      code: 'Backslash',
      key: '&#92',
      shiftKey: '|',
    },
    {
      code: 'Delete',
      key: 'Del',
    },
    {
      code: 'CapsLock',
      key: 'CapsLock',
    },
    {
      code: 'KeyA',
      key: 'a',
      capsKey: 'A',
      shiftKey: 'A',
    },
    {
      code: 'KeyS',
      key: 's',
      capsKey: 'S',
      shiftKey: 'S',
    },
    {
      code: 'KeyD',
      key: 'd',
      capsKey: 'D',
      shiftKey: 'D',
    },
    {
      code: 'KeyF',
      key: 'f',
      capsKey: 'F',
      shiftKey: 'F',
    },
    {
      code: 'KeyG',
      key: 'g',
      capsKey: 'G',
      shiftKey: 'G',
    },
    {
      code: 'KeyH',
      key: 'h',
      capsKey: 'H',
      shiftKey: 'H',
    },
    {
      code: 'KeyJ',
      key: 'j',
      capsKey: 'J',
      shiftKey: 'J',
    },
    {
      code: 'KeyK',
      key: 'k',
      capsKey: 'K',
      shiftKey: 'K',
    },
    {
      code: 'KeyL',
      key: 'l',
      capsKey: 'L',
      shiftKey: 'L',
    },
    {
      code: 'Semicolon',
      key: ';',
      shiftKey: ':',
    },
    {
      code: 'Quote',
      key: "'",
      rightAlt: '"',
    },
    {
      code: 'Enter',
      key: 'Enter',
    },
    {
      code: 'ShiftLeft',
      key: 'Shift',
    },
    {
      code: 'KeyZ',
      key: 'z',
      capsKey: 'Z',
      shiftKey: 'Z',
    },
    {
      code: 'KeyX',
      key: 'x',
      capsKey: 'X',
      shiftKey: 'X',
    },
    {
      code: 'KeyC',
      key: 'c',
      capsKey: 'C',
      shiftKey: 'C',
    },
    {
      code: 'KeyV',
      key: 'v',
      capsKey: 'V',
      shiftKey: 'V',
    },
    {
      code: 'KeyB',
      key: 'b',
      capsKey: 'B',
      shiftKey: 'B',
    },
    {
      code: 'KeyN',
      key: 'n',
      capsKey: 'N',
      shiftKey: 'N',
    },
    {
      code: 'KeyM',
      key: 'm',
      capsKey: 'M',
      shiftKey: 'M',
    },
    {
      code: 'Comma',
      key: ',',
      shiftKey: '<',
    },
    {
      code: 'Period',
      key: '.',
      shiftKey: '>',
    },
    {
      code: 'Slash',
      key: '/',
      shiftKey: '?',
    },
    {
      code: 'ArrowUp',
      key: '&uarr;',
    },
    {
      code: 'ShiftRight',
      key: 'Shift',
    },
    {
      code: 'ControlLeft',
      key: 'Ctrl',
    },
    {
      code: 'MetaLeft',
      key: 'Win',
    },
    {
      code: 'AltLeft',
      key: 'Alt',
    },
    {
      code: 'Space',
      key: ' ',
    },
    {
      code: 'AltRight',
      key: 'Alt',
    },
    {
      code: 'ArrowLeft',
      key: '&larr;',
    },
    {
      code: 'ArrowDown',
      key: '&darr;',
    },
    {
      code: 'ArrowRight',
      key: '&rarr;',
    },
    {
      code: 'ControlRight',
      key: 'Ctrl',
    },
  ],
};

// constructor
class Key {
  constructor({
    key, code, shiftKey, capsKey,
  }) {
    this.key = key;
    this.code = code;
    this.shiftKey = shiftKey;
    this.capsKey = capsKey;
  }

  // keys generator
  keyGenerator() {
    const key = document.createElement('div');
    key.classList.add('key');
    key.innerHTML = this.key;
    key.dataset.code = this.code;
    key.dataset.shiftKey = this.shiftKey;
    key.dataset.capsKey = this.capsKey;
    return key;
  }
}

// render
const renderKeysToDom = () => {
  const langArr = data.englishLang ? data.eng : data.ru;
  langArr.forEach((el) => {
    const key = new Key(el);
    // console.log(key);
    document.querySelector('.keyboard_wrapper').append(key.keyGenerator());
  });
};

// render Global container
const renderGlobalWrapper = () => {
  const container = document.createElement('div');
  container.classList.add('container');

  container.innerHTML = `
  <h1 class="keyboard_title neon_text_flicker">RSS Виртуальная клавиатура</h1>
  <textarea 
    name="display" 
    id="display" 
    class="keyboard_display">
  </textarea>
  <div class="keyboard_wrapper neonBox"></div>
  <p class="lang_description">Для переключения языка нажмите Alt + Shift</p>
  `;

  document.body.append(container);
  return container;
};
const addActiveClass = (code) => {
  const currentKey = document.querySelector(`.key[data-code=${code}]`);
  currentKey?.classList.add('active');
};
const removeActiveClass = (code) => {
  const currentKey = document.querySelector(`.key[data-code=${code}]`);
  currentKey?.classList.remove('active');
};
// функиця удаления текста с экрана
const deleteDisplayText = () => {
  const displayData = data.display;
  const displayElement = document.querySelector('textarea');
  displayData.splice(displayData.length - 1, 1).join('');
  displayElement.value = displayData.join('');
};
// функция переноса на новую строку
const moveANewLine = () => {
  const displayData = data.display.join('');
  const displayElement = document.querySelector('textarea');
  const newLine = '\n';
  displayElement.value = displayData + newLine;
};
// набор текста в инпут
const writeTextToDisplay = (event) => {
  const currentKey = document.querySelector(`.key[data-code=${event.code}]`);

  const displayElement = document.querySelector('textarea');
  const displayData = data.display;
  // проверка чтоб не печатались кнопки которые содержат больше 1 символа
  if (currentKey?.innerText === 'Tab') {
    displayData.push('  ');
  }
  if (currentKey?.innerText.length <= 1) {
    displayData.push(currentKey.innerHTML);
  }
  if (currentKey?.innerText === 'Backspace') {
    deleteDisplayText();
  }
  if (currentKey?.innerText === 'Enter') {
    moveANewLine();
  }
  displayElement.value = displayData.join('');
};

// функция ререндера отдельных кнопок
const rerenderKeyContent = (event) => {
  // переменная с массивом языка
  const langArr = data.englishLang ? data.eng : data.ru;

  const keySet = document.querySelectorAll('.key');
  for (let i = 0; i < keySet.length; i += 1) {
    const currentKeyText = keySet[i].innerText;
    if (event.shiftKey && !event.altKey) {
      const newKeyText = langArr[i].shiftKey ? langArr[i].shiftKey : langArr[i].key;
      const resultText = currentKeyText !== langArr[i].key ? langArr[i].key : newKeyText;
      keySet[i].innerHTML = resultText;
    } else
    if (data.isCapsed) { // +проверка не нажат ли шифт
      const newKeyText = langArr[i].capsKey ? langArr[i].capsKey : langArr[i].key;
      const resultText = currentKeyText !== newKeyText ? newKeyText : currentKeyText;
      keySet[i].innerHTML = resultText;
    } else {
      keySet[i].innerHTML = langArr[i].key;
    }
  }
};
// сохранение в localStorage
const saveToLocalStorage = () => {
  localStorage.setItem('lang', data.englishLang);
};
// загрузка из localStorage
const loadFromLocalStorage = () => {
  const loadedLanguage = localStorage.getItem('lang');
  data.englishLang = JSON.parse(loadedLanguage);
};

const catchCapsKey = (event) => {
  if (event.code === 'CapsLock') {
    data.isCapsed = !data.isCapsed;
    rerenderKeyContent(event);
  }
};
const catchShiftKeys = (event) => {
  if (event.code === 'ShiftLeft' && !event.altKey) {
    if (event.repeat) return;
    rerenderKeyContent(event);
  }
};
const catchLanguageToggleKeys = (event) => {
  if (event.code === 'ShiftLeft' && event.altKey) {
    data.englishLang = !data.englishLang;
    rerenderKeyContent(event);
    saveToLocalStorage();
  }
};
// слушатель для нажатия кнопки
const downKeyHandler = () => {
  const { body } = document;
  body.addEventListener('keydown', (event) => {
    event.preventDefault();
    addActiveClass(event.code);
    writeTextToDisplay(event);
    catchShiftKeys(event);
    // проверка на капс => функция обработки капса
    catchCapsKey(event);
    catchLanguageToggleKeys(event);
  });
};
// слушатель для отжатия кнопки
const upKeyHandler = () => {
  const { body } = document;
  body.addEventListener('keyup', (event) => {
    event.preventDefault();
    removeActiveClass(event.code);
    rerenderKeyContent(event);
  });
};
// init render function
window.onload = function () {
  renderGlobalWrapper();
  loadFromLocalStorage();
  renderKeysToDom();
  downKeyHandler();
  upKeyHandler();
};
